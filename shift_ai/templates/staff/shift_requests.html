{% extends 'staff/base.html' %}

{% block page_title %}シフト提出{% endblock %}

{% block content %}

<!-- シフト提出カレンダー -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="m-0 font-weight-bold text-primary">シフト提出カレンダー</h6>
                    {% if today < submission_start %}
                        <small class="text-warning">
                            <i class="fas fa-clock me-1"></i>提出開始: {{ submission_start|date:"m月d日" }}
                        </small>
                    {% elif not can_edit %}
                        <small class="text-danger">
                            <i class="fas fa-lock me-1"></i>提出期限を過ぎました（{{ submission_deadline|date:"m月d日" }}まで）
                        </small>
                    {% else %}
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>提出期限: {{ submission_deadline|date:"m月d日" }}
                        </small>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if can_edit %}
                        <button type="button" class="btn btn-sm btn-outline-warning" id="edit-mode-btn" onclick="toggleEditMode()">
                            <i class="fas fa-edit me-1"></i>編集モード
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="save-changes-btn" onclick="saveAllChanges()" style="display: none;" disabled>
                            <i class="fas fa-save me-1"></i>変更を保存
                        </button>
                    {% endif %}
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="btn btn-sm btn-outline-secondary disabled" id="current-month">{{ month_start|date:"Y年m月" }}</span>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if today < submission_start %}
                    <div class="alert alert-info">
                        <i class="fas fa-clock me-2"></i>
                        シフト提出は{{ submission_start|date:"m月d日" }}から開始されます。
                    </div>
                {% elif not can_edit %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        提出期限を過ぎたため、シフトの新規提出・編集はできません。管理者にご連絡ください。
                    </div>
                {% endif %}
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    カレンダーは{{ month_start|date:"Y年m月" }}の提出用です。カレンダーに表示されている日付を選択してシフトを提出してください。
                </div>
                
                <!-- 編集モード用のフォーム -->
                <div id="edit-mode-form" style="display: none;">
                    {% csrf_token %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        編集モード：カレンダー上の日付をクリックして、時間を入力してください。
                    </div>
                    
                    <!-- 選択された日付表示 -->
                    <div class="mb-3" id="selected-date-display" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-calendar-alt me-2"></i>
                            <strong>選択日：</strong><span id="selected-date-text">-</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">希望種別</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="edit_request_type" id="edit_work_type" value="work" checked>
                                <label class="btn btn-outline-success" for="edit_work_type">勤務希望</label>
                                
                                <input type="radio" class="btn-check" name="edit_request_type" id="edit_off_type" value="off">
                                <label class="btn btn-outline-warning" for="edit_off_type">休み希望</label>
                                
                                <input type="radio" class="btn-check" name="edit_request_type" id="edit_overtime_type" value="overtime">
                                <label class="btn btn-outline-info" for="edit_overtime_type">残業希望</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">時間設定</label>
                            <div class="time-picker-group">
                                <div class="time-picker">
                                    <span class="time-label">開始</span>
                                    <div class="date-display">
                                        <small class="text-muted" id="start-date-label">開始日</small>
                                    </div>
                                    <div class="time-selector">
                                        <select id="edit_start_hour" class="hour-select">
                                            <option value="">--</option>
                                        </select>
                                        <span class="time-separator">:</span>
                                        <select id="edit_start_minute" class="minute-select">
                                            <option value="">--</option>
                                        </select>
                                    </div>
                                </div>
                                <span class="time-separator">-</span>
                                <div class="time-picker">
                                    <span class="time-label">終了</span>
                                    <div class="date-display">
                                        <small class="text-muted" id="end-date-label">終了日</small>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-end-date" onclick="toggleEndDate()">
                                            <i class="fas fa-arrow-down"></i> 翌日に
                                        </button>
                                    </div>
                                    <div class="time-selector">
                                        <select id="edit_end_hour" class="hour-select">
                                            <option value="">--</option>
                                        </select>
                                        <span class="time-separator">:</span>
                                        <select id="edit_end_minute" class="minute-select">
                                            <option value="">--</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" id="complete-button" onclick="addShiftFromTimeInput()" style="margin-left: 15px; align-self: flex-end;">
                                    <i class="fas fa-check"></i> 完了
                                </button>
                            </div>
                            <!-- 隠しフィールド -->
                            <input type="hidden" id="edit_start_time" name="edit_start_time">
                            <input type="hidden" id="edit_end_time" name="edit_end_time">
                            <input type="hidden" id="edit_end_date_offset" name="edit_end_date_offset" value="0">
                            <small class="text-muted">右クリックでシフトを削除できます</small>
                        </div>
                    </div>
                </div>

                
                <!-- カレンダー表示 -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-weekdays">
                            <div class="weekday sunday">日</div>
                            <div class="weekday">月</div>
                            <div class="weekday">火</div>
                            <div class="weekday">水</div>
                            <div class="weekday">木</div>
                            <div class="weekday">金</div>
                            <div class="weekday saturday">土</div>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        {% for week in calendar_weeks %}
                        <div class="calendar-week">
                            {% for day in week %}
                            <div class="calendar-day {% if day.is_current_month %}current-month{% else %}other-month{% endif %} {% if day.date|date:'D' == 'Sun' %}sunday{% elif day.date|date:'D' == 'Sat' %}saturday{% endif %}" 
                                 data-date="{{ day.date|date:'Y-m-d' }}" 
                                 onclick="{% if can_edit %}selectDate(this){% endif %}"
                                 oncontextmenu="{% if can_edit %}deleteShiftOnRightClick(this, event){% endif %}">
                                <div class="day-content">
                                    <div class="day-number">{{ day.date|date:"j" }}</div>
                                    <div class="day-status" id="status_{{ day.date|date:'Y-m-d' }}" data-submitted="{{ day.date|date:'Y-m-d' }}">
                                    </div>
                                    {% if can_edit %}
                                    <button type="button" class="btn-delete-shift" onclick="deleteShiftFromButton(this, event)" data-date="{{ day.date|date:'Y-m-d' }}" style="display: none; position: absolute; top: 2px; right: 2px; padding: 2px 6px; font-size: 10px; line-height: 1; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;" title="シフトを削除">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<!-- 希望シフト提出ルール -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">提出ルール</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>勤務希望</h6>
                            <p class="mb-0">希望する勤務日と時間を指定してください</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-calendar-times me-2"></i>休み希望</h6>
                            <p class="mb-0">勤務できない日を指定してください</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-clock me-2"></i>残業希望</h6>
                            <p class="mb-0">追加で勤務したい日と時間を指定してください</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedDates = [];
let isEditMode = false;
let pendingChanges = {}; // 編集モードでの変更を追跡

// 提出済みシフトのデータ
let submittedShifts = {
    {% for date, shift in submitted_shifts.items %}
    '{{ date|date:"Y-m-d" }}': {
        request_type: '{{ shift.request_type }}',
        start_time: '{{ shift.start_time|time:"H:i" }}',
        end_time: '{{ shift.end_time|time:"H:i" }}'
    },
    {% endfor %}
};

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    loadExistingRequests();
    highlightToday();
    displaySubmittedShifts();
    // 時間選択は編集モードに入ってから初期化
});

// メモリーの時間選択を初期化


// 時間選択機能の初期化
function initializeTimePickers() {
    // 時間オプション（0-23時）
    const hourSelect = document.getElementById('edit_start_hour');
    const hourSelectEnd = document.getElementById('edit_end_hour');
    
    console.log('hourSelect:', hourSelect);
    console.log('hourSelectEnd:', hourSelectEnd);
    
    if (!hourSelect || !hourSelectEnd) {
        console.error('Time picker elements not found!');
        return;
    }
    
    // 既存のオプションをクリア（"--"を除く）
    while (hourSelect.options.length > 1) {
        hourSelect.remove(1);
    }
    while (hourSelectEnd.options.length > 1) {
        hourSelectEnd.remove(1);
    }
    
    // 時間オプションを追加
    for (let i = 0; i <= 23; i++) {
        const hour = String(i).padStart(2, '0');
        const option1 = new Option(hour, hour, false, false);
        const option2 = new Option(hour, hour, false, false);
        hourSelect.appendChild(option1);
        hourSelectEnd.appendChild(option2);
    }
    
    console.log('Hour options added. Count:', hourSelect.options.length);
    
    // 分オプション（0-45分、15分間隔）
    const minuteSelect = document.getElementById('edit_start_minute');
    const minuteSelectEnd = document.getElementById('edit_end_minute');
    
    console.log('minuteSelect:', minuteSelect);
    console.log('minuteSelectEnd:', minuteSelectEnd);
    
    if (!minuteSelect || !minuteSelectEnd) {
        console.error('Minute picker elements not found!');
        return;
    }
    
    // 既存のオプションをクリア（"--"を除く）
    while (minuteSelect.options.length > 1) {
        minuteSelect.remove(1);
    }
    while (minuteSelectEnd.options.length > 1) {
        minuteSelectEnd.remove(1);
    }
    
    // 分オプションを追加（0, 15, 30, 45分）
    const minutes = ['00', '15', '30', '45'];
    minutes.forEach((min, index) => {
        // 最初のオプション（00）をデフォルトで選択
        const option1 = new Option(min, min, index === 0, index === 0);
        const option2 = new Option(min, min, index === 0, index === 0);
        minuteSelect.appendChild(option1);
        minuteSelectEnd.appendChild(option2);
    });
    
    console.log('Minute options added. Count:', minuteSelect.options.length);
}

// 時間選択のイベント設定
function setupTimePickerEvents() {
    const startHour = document.getElementById('edit_start_hour');
    const startMinute = document.getElementById('edit_start_minute');
    const endHour = document.getElementById('edit_end_hour');
    const endMinute = document.getElementById('edit_end_minute');
    
    if (startHour && startMinute && endHour && endMinute) {
        // 開始時間
        startHour.addEventListener('change', updateHiddenTimeField);
        startMinute.addEventListener('change', updateHiddenTimeField);
        
        // 終了時間
        endHour.addEventListener('change', updateHiddenTimeField);
        endMinute.addEventListener('change', updateHiddenTimeField);
    } else {
        console.error('Time picker elements not found for event setup');
    }
}

// 隠しフィールドを更新
function updateHiddenTimeField() {
    const startHour = document.getElementById('edit_start_hour').value;
    const startMinute = document.getElementById('edit_start_minute').value;
    const endHour = document.getElementById('edit_end_hour').value;
    const endMinute = document.getElementById('edit_end_minute').value;
    
    const startTime = (startHour && startMinute) ? `${startHour}:${startMinute}` : '';
    const endTime = (endHour && endMinute) ? `${endHour}:${endMinute}` : '';
    
    document.getElementById('edit_start_time').value = startTime;
    document.getElementById('edit_end_time').value = endTime;
}

// 編集モード切り替え
function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('edit-mode-btn');
    const saveBtn = document.getElementById('save-changes-btn');
    const editForm = document.getElementById('edit-mode-form');
    
    console.log('toggleEditMode:', isEditMode, editForm);
    
    if (isEditMode) {
        editBtn.innerHTML = '<i class="fas fa-times me-1"></i>編集終了';
        editBtn.classList.remove('btn-outline-warning');
        editBtn.classList.add('btn-warning');
        saveBtn.style.display = 'inline-block';
        if (editForm) {
            editForm.style.display = 'block';
            console.log('Edit form displayed');
            
            // 編集モードに入ったら時間選択を初期化
            initializeTimePickers();
            setupTimePickerEvents();
            
            // 分のデフォルト値を「00」に設定
            document.getElementById('edit_start_minute').value = '00';
            document.getElementById('edit_end_minute').value = '00';
        } else {
            console.error('Edit form not found!');
        }
        
        // 提出済みシフトを編集可能にする
        document.querySelectorAll('.calendar-day.submitted').forEach(cell => {
            cell.classList.remove('submitted');
            cell.style.cursor = 'pointer';
            // 削除ボタンを表示（提出済みシフトがある日のみ）
            const date = cell.dataset.date;
            if (date in submittedShifts) {
                const deleteBtn = cell.querySelector('.btn-delete-shift');
                if (deleteBtn) {
                    deleteBtn.style.display = 'block';
                }
            }
        });
        
        // 提出済みシフトがある日のみ削除ボタンを表示
        for (const date in submittedShifts) {
            const cell = document.querySelector(`[data-date="${date}"]`);
            if (cell) {
                const deleteBtn = cell.querySelector('.btn-delete-shift');
                if (deleteBtn) {
                    deleteBtn.style.display = 'block';
                }
            }
        }
    } else {
        editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>編集モード';
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-outline-warning');
        saveBtn.style.display = 'none';
        if (editForm) editForm.style.display = 'none';
        
        // 提出済みシフトを元に戻す
        displaySubmittedShifts();
        pendingChanges = {};
        
        // 削除ボタンを非表示（編集モード終了時）
        document.querySelectorAll('.btn-delete-shift').forEach(btn => {
            btn.style.display = 'none';
        });
    }
}

// 選択したシフトを削除
let selectedShiftDate = null;

// カレンダー機能
let currentSelectedDate = null;

function selectDate(cell) {
    if (!cell.classList.contains('current-month')) return;
    
    console.log('selectDate called, isEditMode:', isEditMode);
    
    // 提出期限を過ぎている場合は選択不可
    const canEdit = {{ can_edit|lower }};
    if (!canEdit) {
        alert('提出期限を過ぎたため、シフトの変更はできません。');
        return;
    }
    
    const date = cell.dataset.date;
    
    if (isEditMode) {
        // 日付を選択
        currentSelectedDate = date;
        
        // 既存の選択を解除
        document.querySelectorAll('.calendar-day.selected-edit').forEach(c => {
            c.classList.remove('selected-edit');
        });
        
        // 選択された日付をハイライト
        cell.classList.add('selected-edit');
        
        // 選択された日付を表示
        displaySelectedDate(date);
        
        // 既存のシフトがあれば削除
        if (date in submittedShifts) {
            delete submittedShifts[date];
        }
        
        console.log('Date selected:', date);
    } else {
        // 通常モード：編集モードでのみシフト追加可能
        if (date in submittedShifts) {
            alert('この日は既にシフトが提出されています。編集する場合は「編集モード」ボタンを押してください。');
        } else {
            alert('シフトを追加するには「編集モード」ボタンを押してから操作してください。');
        }
        return;
    }
}

// 時間を分に変換
function parseTimeToMinutes(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
}

// 日付を1日加算
function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

// 日付をフォーマット
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 時間が重複しているかチェック
function isTimeOverlap(start1, end1, start2, end2) {
    // 重複判定: (start1 < end2) && (start2 < end1)
    return (start1 < end2) && (start2 < end1);
}

// 日付が隣接しているかチェック（1日差以内）
function isAdjacentDates(date1, date2) {
    const diffTime = Math.abs(date1 - date2);
    const diffDays = diffTime / (1000 * 60 * 60 * 24);
    return diffDays <= 1;
}

// 選択された日付を表示
function displaySelectedDate(dateStr) {
    const dateObj = new Date(dateStr + 'T00:00:00');
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth() + 1;
    const day = dateObj.getDate();
    const weekday = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
    
    document.getElementById('selected-date-text').textContent = `${year}年${month}月${day}日(${weekday})`;
    document.getElementById('selected-date-display').style.display = 'block';
    
    // 開始日・終了日を表示
    document.getElementById('start-date-label').textContent = `${month}月${day}日`;
    document.getElementById('end-date-label').textContent = `${month}月${day}日`;
    
    // 終了日のオフセットをリセット
    document.getElementById('edit_end_date_offset').value = '0';
}

// 日付をまたぐかどうかを切り替え
function toggleEndDate() {
    const offsetField = document.getElementById('edit_end_date_offset');
    const endDateLabel = document.getElementById('end-date-label');
    const toggleBtn = document.getElementById('toggle-end-date');
    
    if (currentSelectedDate === null) {
        alert('先に日付を選択してください。');
        return;
    }
    
    const currentOffset = parseInt(offsetField.value);
    const newOffset = currentOffset === 0 ? 1 : 0;
    offsetField.value = newOffset;
    
    const dateObj = new Date(currentSelectedDate + 'T00:00:00');
    const nextDateObj = new Date(dateObj);
    nextDateObj.setDate(nextDateObj.getDate() + newOffset);
    
    const month = nextDateObj.getMonth() + 1;
    const day = nextDateObj.getDate();
    
    endDateLabel.textContent = `${month}月${day}日`;
    toggleBtn.innerHTML = newOffset === 0 ? '<i class="fas fa-arrow-down"></i> 翌日に' : '<i class="fas fa-arrow-up"></i> 同じ日に';
}

// 時間入力後にシフトを追加
function addShiftFromTimeInput() {
    if (currentSelectedDate === null) {
        alert('先に日付を選択してください。');
        return;
    }
    
    const requestTypeRadio = document.querySelector('input[name="edit_request_type"]:checked');
    const requestType = requestTypeRadio ? requestTypeRadio.value : 'work';
    const startTimeInput = document.getElementById('edit_start_time');
    const endTimeInput = document.getElementById('edit_end_time');
    const endDateOffset = document.getElementById('edit_end_date_offset').value;
    const startTime = startTimeInput ? startTimeInput.value : '';
    const endTime = endTimeInput ? endTimeInput.value : '';
    
    // 時間が入力されている場合のみ処理を進める
    if (!(requestType === 'off' || (startTime && endTime))) {
        alert('開始時間と終了時間を入力してください。');
        return;
    }
    
    // 時間の検証
    if (requestType !== 'off') {
        const startHour = parseInt(startTime.split(':')[0]);
        const endHour = parseInt(endTime.split(':')[0]);
        
        // 終了時間が開始時間より後であるか確認
        const totalEndHour = endHour + (parseInt(endDateOffset) * 24);
        if (totalEndHour <= startHour) {
            alert('終了時間は開始時間より後である必要があります。');
            return;
        }
        
        // 24時間を超える場合は警告
        const duration = (totalEndHour - startHour) + (parseInt(endTime.split(':')[1]) - parseInt(startTime.split(':')[1])) / 60;
        if (duration > 24) {
            if (!confirm('24時間を超えるシフトですが、よろしいですか？')) {
                return;
            }
        }
        
        // シフトの重複チェック
        const currentDate = new Date(currentSelectedDate + 'T00:00:00');
        const currentEndDate = new Date(currentDate);
        currentEndDate.setDate(currentEndDate.getDate() + parseInt(endDateOffset));
        
        // 既存のシフトをチェック
        for (const [dateKey, shiftData] of Object.entries(submittedShifts)) {
            const existingDate = new Date(dateKey + 'T00:00:00');
            const existingStartTime = shiftData.start_time;
            const existingEndTime = shiftData.end_time;
            
            if (existingStartTime && existingEndTime) {
                // 既存シフトの時間を分に変換
                const existingStart = parseTimeToMinutes(existingStartTime);
                let existingEnd = parseTimeToMinutes(existingEndTime);
                
                // 新規シフトの時間を分に変換
                const newStart = parseTimeToMinutes(startTime);
                let newEnd = parseTimeToMinutes(endTime);
                
                // 日付をまたぐ場合は終了時間に1440分（24時間）を加算
                // 既存シフトが翌日にまたがるかどうかは簡易的にチェック
                if (existingEnd <= existingStart) {
                    existingEnd += 1440; // 翌日
                }
                
                // 新規シフトが翌日にまたがる場合
                if (newEnd <= newStart || parseInt(endDateOffset) > 0) {
                    newEnd += 1440 * (parseInt(endDateOffset) + 1); // 翌日
                }
                
                // 重複チェック（同じ日のみ）
                const existingDateStr = dateKey;
                const newDateStr = currentSelectedDate;
                
                // 同じ日の場合のみ重複チェック（2日続けて提出する場合は別の日として扱う）
                if (existingDateStr === newDateStr) {
                    if (isTimeOverlap(
                        existingStart, existingEnd,
                        newStart, newEnd
                    )) {
                        alert('シフトの時間が重複しています。別の時間を指定してください。');
                        return;
                    }
                }
            }
        }
        
        // pendingChangesもチェック（同じ日のみ）
        for (const [dateKey, changeData] of Object.entries(pendingChanges)) {
            if (changeData.action === 'update' && changeData.start_time && changeData.end_time) {
                // 同じ日の場合のみ重複チェック
                if (dateKey === currentSelectedDate) {
                    const existingStart = parseTimeToMinutes(changeData.start_time);
                    const existingEnd = parseTimeToMinutes(changeData.end_time) + (changeData.end_date_offset || 0) * 1440;
                    const newStart = parseTimeToMinutes(startTime);
                    const newEnd = parseTimeToMinutes(endTime) + parseInt(endDateOffset) * 1440;
                    
                    if (isTimeOverlap(existingStart, existingEnd, newStart, newEnd)) {
                        alert('シフトの時間が重複しています。別の時間を指定してください。');
                        return;
                    }
                }
            }
        }
    }
    
    const cell = document.querySelector(`[data-date="${currentSelectedDate}"]`);
    const isExistingShift = currentSelectedDate in pendingChanges;
    
    // 新しいシフトを追加
    pendingChanges[currentSelectedDate] = {
        action: 'update',
        request_type: requestType,
        start_time: startTime,
        end_time: endTime,
        end_date_offset: endDateOffset
    };
    
    // カレンダー表示を更新
    cell.classList.remove('deleted', 'selected-edit');
    cell.classList.add('modified');
    updateDayStatusForEdit(cell, requestType, startTime, endTime);
    
    if (isExistingShift) {
        alert(`${currentSelectedDate}のシフトを更新しました。`);
    } else {
        alert(`${currentSelectedDate}にシフトを追加しました。`);
    }
    
    // 保存ボタンを有効化
    const saveBtn = document.getElementById('save-changes-btn');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<i class="fas fa-save me-1"></i>変更を保存 (${Object.keys(pendingChanges).length}件)`;
    }
    
    // 選択をリセット
    currentSelectedDate = null;
    document.getElementById('selected-date-display').style.display = 'none';
}

// ボタンからシフトを削除
function deleteShiftFromButton(button, event) {
    event.stopPropagation(); // 親要素のクリックイベントを防止
    
    const cell = button.closest('.calendar-day');
    deleteShiftOnRightClick(cell, event);
}

// 右クリックでシフトを削除
function deleteShiftOnRightClick(cell, event) {
    console.log('deleteShiftOnRightClick called, isEditMode:', isEditMode);
    
    // 編集モードでない場合は削除不可
    if (!isEditMode) {
        event.preventDefault();
        alert('シフトを削除するには「編集モード」ボタンを押してから操作してください。');
        return;
    }
    
    // 提出期限を過ぎている場合は削除不可
    const canEdit = {{ can_edit|lower }};
    if (!canEdit) {
        event.preventDefault();
        alert('提出期限を過ぎたため、シフトの削除はできません。');
        return;
    }
    
    const date = cell.dataset.date;
    
    // シフトが存在しない場合は削除できない
    if (!(date in submittedShifts)) {
        event.preventDefault();
        return;
    }
    
    event.preventDefault(); // コンテキストメニューを無効化
    
    console.log('Date to delete:', date);
    
    if (!confirm(`${date}のシフトを削除しますか？`)) {
        return;
    }
    
    // 既存のシフトを削除
    if (date in submittedShifts) {
        delete submittedShifts[date];
    }
    
    // 削除を記録
    pendingChanges[date] = {
        action: 'delete'
    };
    
    // カレンダー表示をクリア
    const statusDiv = cell.querySelector('.day-status');
    if (statusDiv) {
        statusDiv.innerHTML = '';
    }
    cell.classList.remove('modified', 'selected-edit', 'submitted');
    cell.classList.add('deleted');
    
    alert(`${date}のシフトを削除しました。変更を保存ボタンを押して確定してください。`);
    
    // 保存ボタンを有効化
    const saveBtn = document.getElementById('save-changes-btn');
    if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<i class="fas fa-save me-1"></i>変更を保存 (${Object.keys(pendingChanges).length}件)`;
    }
}

// 編集モード用の日付表示更新
function updateDayStatusForEdit(cell, type, startTime, endTime) {
    const statusDiv = cell.querySelector('.day-status');
    if (!statusDiv) return;
    
    let statusHtml = '';
    if (type === 'work' && startTime && endTime) {
        statusHtml = `<small class="badge bg-success">${startTime}-${endTime}</small>`;
    } else if (type === 'off') {
        statusHtml = `<small class="badge bg-warning">休み</small>`;
    } else if (type === 'overtime' && startTime && endTime) {
        statusHtml = `<small class="badge bg-info">残業 ${startTime}-${endTime}</small>`;
    }
    
    statusDiv.innerHTML = statusHtml;
    cell.classList.add('modified');
}







// 変更を保存
function saveAllChanges() {
    console.log('saveAllChanges called, pendingChanges:', pendingChanges);
    
    if (Object.keys(pendingChanges).length === 0) {
        alert('変更がありません。');
        return;
    }
    
    if (!confirm(`${Object.keys(pendingChanges).length}件の変更を保存しますか？`)) {
        return;
    }
    
    // フォームデータを作成
    const formData = new FormData();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found!');
        alert('セキュリティエラーが発生しました。ページを更新してください。');
        return;
    }
    formData.append('csrfmiddlewaretoken', csrfToken.value);
    formData.append('action', 'update_existing');
    
    console.log('FormData created, action:', 'update_existing');
    
    // 削除と更新を分けて処理
    const deleteDates = [];
    const updateDates = [];
    const requestTypes = [];
    const startTimes = [];
    const endTimes = [];
    const endDateOffsets = [];
    
    for (const [date, change] of Object.entries(pendingChanges)) {
        console.log('Processing change:', date, change);
        if (change.action === 'delete') {
            deleteDates.push(date);
        } else if (change.action === 'update') {
            updateDates.push(date);
            requestTypes.push(change.request_type);
            startTimes.push(change.start_time);
            endTimes.push(change.end_time);
            endDateOffsets.push(change.end_date_offset || '0');
        }
    }
    
    console.log('Delete dates:', deleteDates);
    console.log('Update dates:', updateDates);
    
    // 削除データを追加
    deleteDates.forEach(date => {
        formData.append('delete_dates', date);
    });
    
    // 更新データを追加
    updateDates.forEach(date => {
        formData.append('update_dates', date);
    });
    requestTypes.forEach(type => {
        formData.append('request_types', type);
    });
    startTimes.forEach(time => {
        formData.append('start_times', time);
    });
    endTimes.forEach(time => {
        formData.append('end_times', time);
    });
    endDateOffsets.forEach(offset => {
        formData.append('end_date_offsets', offset);
    });
    
    // 送信
    console.log('Sending request to:', window.location.href);
    console.log('FormData keys:', Array.from(formData.keys()));
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (response.ok) {
            alert('シフトの変更が完了しました！');
            location.reload();
        } else {
            console.error('Response not OK:', response.status);
            alert('エラーが発生しました。ステータス: ' + response.status);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

// シフト提出
function submitShiftRequests() {
    if (selectedDates.length === 0) {
        alert('日付を選択してください。');
        return;
    }
    
    const requestType = getSelectedType();
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    
    if (requestType !== 'off' && (!startTime || !endTime)) {
        alert('開始時間と終了時間を入力してください。');
        return;
    }
    
    // フォームデータを作成
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('request_type', requestType);
    formData.append('start_time', startTime);
    formData.append('end_time', endTime);
    
    selectedDates.forEach(date => {
        formData.append('dates', date);
    });
    
    // 送信
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            alert('シフト提出が完了しました！');
            location.reload();
        } else {
            alert('エラーが発生しました。');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。');
    });
}

// 提出済みシフトを表示
function displaySubmittedShifts() {
    for (const [date, shift] of Object.entries(submittedShifts)) {
        const cell = document.querySelector(`[data-date="${date}"]`);
        if (cell) {
            // 提出済みマークを追加
            cell.classList.add('submitted');
            const statusDiv = cell.querySelector('.day-status');
            if (statusDiv) {
                let statusHtml = '';
                if (shift.request_type === 'work') {
                    statusHtml = `<small class="badge bg-success">${shift.start_time}-${shift.end_time}</small>`;
                } else if (shift.request_type === 'off') {
                    statusHtml = `<small class="badge bg-warning">休み</small>`;
                } else if (shift.request_type === 'overtime') {
                    statusHtml = `<small class="badge bg-info">残業 ${shift.start_time}-${shift.end_time}</small>`;
                }
                statusDiv.innerHTML = statusHtml;
            }
            
            // 削除ボタンは編集モードでのみ表示
            const deleteBtn = cell.querySelector('.btn-delete-shift');
            if (deleteBtn && isEditMode) {
                deleteBtn.style.display = 'block';
            } else if (deleteBtn) {
                deleteBtn.style.display = 'none';
            }
        }
    }
}

// 既存の希望シフトを読み込み
function loadExistingRequests() {
    // 提出済みシフトをカレンダーに表示
    displaySubmittedShifts();
}

// 今日の日付をハイライト
function highlightToday() {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    
    const todayCell = document.querySelector(`[data-date="${todayString}"]`);
    if (todayCell && todayCell.classList.contains('current-month')) {
        todayCell.classList.add('today');
    }
}

// 月移動（簡易版）
function previousMonth() {
    // 実装は省略
    console.log('Previous month');
}

function nextMonth() {
    // 実装は省略
    console.log('Next month');
}

// 削除機能
function deleteRequest(requestId) {
    if (confirm('この希望シフトを削除しますか？')) {
        fetch(`/staff/shift/delete-request/${requestId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('削除に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました。');
        });
    }
}
</script>

<style>
/* カレンダーコンテナ */
.calendar-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* カレンダーヘッダー */
.calendar-header {
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 600;
    font-size: 14px;
}

.weekday {
    padding: 12px 8px;
    border-right: 1px solid #ddd;
    background: #f8f9fa;
}

.weekday:last-child {
    border-right: none;
}

.weekday.sunday {
    color: #dc3545;
}

.weekday.saturday {
    color: #007bff;
}

/* カレンダーグリッド */
.calendar-grid {
    display: flex;
    flex-direction: column;
}

.calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    border-bottom: 1px solid #ddd;
}

.calendar-week:last-child {
    border-bottom: none;
}

/* カレンダー日 */
.calendar-day {
    min-height: 80px;
    border-right: 1px solid #ddd;
    cursor: pointer;
    transition: background-color 0.2s ease;
    position: relative;
    background: white;
}

.calendar-day:last-child {
    border-right: none;
}

.calendar-day.current-month {
    background: white;
}

.calendar-day.current-month:hover {
    background: #f0f8ff !important;
}

.calendar-day.selected {
    background: #e3f2fd !important;
    border: 2px solid #2196f3;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.calendar-day.other-month:hover {
    background: #f8f9fa !important;
}

/* 日付コンテンツ */
.day-content {
    padding: 8px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.day-number {
    font-weight: 600;
    font-size: 16px;
    line-height: 1;
    margin-bottom: 4px;
}

.day-status {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.day-status .badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
    text-align: center;
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* 土日の色分け */
.calendar-day.sunday .day-number {
    color: #dc3545;
}

.calendar-day.saturday .day-number {
    color: #007bff;
}

.calendar-day.selected.sunday .day-number,
.calendar-day.selected.saturday .day-number {
    color: #333;
}

/* 今日の日付 */
.calendar-day.today {
    background: #e8f5e8 !important;
    border: 2px solid #28a745;
}

.calendar-day.today .day-number {
    font-weight: 700;
    color: #155724;
}

/* メモリーセクション */
/* ボタンスタイル */
.btn-group .btn-check:checked + .btn {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#current-month {
    min-width: 120px;
    font-weight: 600;
}

/* レスポンシブデザイン */
@media (max-width: 768px) {
    .calendar-day {
        min-height: 60px;
    }
    
    .day-content {
        padding: 6px 4px;
    }
    
    .day-number {
        font-size: 14px;
    }
    
    .day-status .badge {
        font-size: 9px;
        padding: 1px 4px;
    }
}

/* 選択状態のアニメーション */
.calendar-day.selected {
    animation: selectPulse 0.3s ease-in-out;
}

@keyframes selectPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* ホバー効果 */
.calendar-day.current-month:hover .day-number {
    font-size: 18px;
    transition: font-size 0.2s ease;
}

/* 選択された日付のスタイル */
.calendar-day.selected .day-number {
    font-weight: 700;
    color: #1976d2;
}

/* 提出済みの日付のスタイル */
.calendar-day.submitted {
    background: #f8f9fa !important;
    cursor: not-allowed;
    opacity: 0.8;
}

.calendar-day.submitted:hover {
    background: #f8f9fa !important;
}

.calendar-day.submitted .day-number {
    color: #6c757d;
}

.calendar-day.submitted .day-status .badge {
    cursor: default;
}

/* 編集された日付のスタイル */
.calendar-day.modified {
    background: #fff3cd !important;
    border: 2px solid #ffc107;
}

.calendar-day.modified .day-number {
    color: #856404;
    font-weight: 700;
}

/* 削除された日付のスタイル */
.calendar-day.deleted {
    background: #f8d7da !important;
    border: 2px solid #dc3545;
    opacity: 0.7;
}

.calendar-day.deleted .day-number {
    color: #721c24;
    text-decoration: line-through;
}

/* 編集モードで選択された日付のスタイル */
.calendar-day.selected-edit {
    background: #e7f3ff !important;
    border: 2px solid #0d6efd;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
}

/* 時間選択UI */
.time-picker-group {
    display: flex;
    align-items: center;
    gap: 15px;
}

.time-picker {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.date-display {
    display: flex;
    align-items: center;
    gap: 5px;
}

.date-display small {
    font-size: 11px;
}

.time-label {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    text-align: center;
}

.time-selector {
    display: flex;
    align-items: center;
    gap: 5px;
}

.time-selector select {
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #495057;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 16px 12px;
    padding-right: 35px;
}

.time-selector select:hover {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.time-selector select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.hour-select {
    min-width: 70px;
}

.minute-select {
    min-width: 70px;
}

.time-separator {
    font-size: 20px;
    font-weight: 600;
    color: #6c757d;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .time-picker-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .time-selector {
        justify-content: center;
    }
    
    .hour-select,
    .minute-select {
        min-width: 60px;
    }
}
</style>
{% endblock %}


